---
title: "main"
author: "Nils Tinner, Patrick Bigler"
date: "`r Sys.Date()`"
output: html_document
---
Setup
```{r}
packages <- c("influxdbclient","ggplot2","tidyverse","lubridate","raster","dplyr","googledrive","caret","rgdal","keras","vip")

source("../R/load_packages.R")
load_packages(packages)

```

Data Wrangling

```{r}
source("../R/data_combination.R")
#here add check, if present load if not run function
# combined <- data_combination() |> drop_na() #not very clean but okay
combined <- read_csv("../data/Combined.csv") |> drop_na()


combined_test <- combined |> filter(year == 2021) |>
  filter((Log_Nr %in% c(82,45)))
combined_train <- combined |> filter(year %in% c(2019,2020,2022)) |>
  filter(!(Log_Nr %in% c(82,45)))

```

Model Definitions
```{r}
predictors <- combined |>
  dplyr::select(-c(Log_Nr,temperature,Name,NORD_CHTOP,OST_CHTOPO,LV_03_N,LV_03_E)) |>
  colnames()
  formula_local <- as.formula(paste("temperature","~", paste(predictors,collapse  = "+")))
  

  pp <- recipes::recipe(formula_local,
                        data = combined_train) |>
    recipes::step_center(recipes::all_numeric(), -recipes::all_outcomes()) |>
    recipes::step_scale(recipes::all_numeric(), -recipes::all_outcomes())
  


```
Model Training

```{r}
source("../R/random_forest.R")
random_forest_model <- random_forest(pp,combined_train)

  combined_test$fitted <- predict(mod_cv, newdata = combined_test)
  metrics_test <- combined_test |> 
    yardstick::metrics(temperature, fitted)
  
  combined_test<- combined_test|>mutate(difference = fitted-temperature)
  
  
```
Evaluation

```{r}


```
